# HTTPS

## HTTP 的确定

- 信息明文传递 --- 可能被窃听

- 不能认证通信双方的身份 --- 可能通信双方会被伪装

- 无法验证报文完整性 --- 传输过程中可能遭遇篡改

## HTTPS

### 加密

- 共享密钥加密（对称加密）

加密和解密使用相同的密钥

缺点就是需要将密钥也传递给对方，无法保证安全的转交密钥

- 公开密钥加密（非对称加密）

公钥加密，私钥解密

缺点：速度慢，无法证明公钥的准确性。（解决方法就是数字证书）

- 混合加密（对称加密+非对称加密）

交换密钥环节使用非对称加密

报文传输阶段使用对称加密

### 认证

- 服务器会将带有公钥的证书发送给客户端

- 客户端收到证书之后会对证书进行验证。验证通过时就可以确定两个问题： 1. 认证服务器的公开密钥的是真实有效的数字证书认证机构。2. 服务器是可以信赖的

### 完整性保护

1. 为了避免网络中传输的数据被非法篡改，SSL 利用基于 MD5 或 SHA 的 MAC 算法来保证消息的完整性。

2. 只要源文本不同，计算得到的结果，必然不同（或者说机会很少）。

3. 无法从结果反推出源数据。常见的摘要算法有 MD5、SHA 等

4. MAC 算法：MAC 算法是在密钥参与下的数据摘要算法，能将密钥和任意长度的数据转换为固定长度的数据。利用 MAC 算法验证消息完整性的过程如图所示。发送者在密钥的参与下，利用 MAC 算法计算出消息的 MAC 值，并将其加在消息之后发送给接收者。接收者利用同样的密钥和 MAC 算法计算出消息的 MAC 值，并与接收到的 MAC 值比较。如果二者相同，则报文没有改变；否则，报文在传输过程中被修改，接收者将丢弃该报文。

5. MAC 算法具有如下特征，使其能够用来验证消息的完整性

   - 消息的任何改变，都会引起输出的固定长度数据产生变化。通过比较 MAC 值，可以保证接收者能够发现消息的改变

   - MAC 算法需要密钥的参与，因此没有密钥的非法用户在改变消息的内容后，无法添加正确的 MAC 值，从而保证非法用户无法随意修改消息内容。

   - MAC 算法要求通信双方具有相同的密钥，否则 MAC 值验证将会失败。因此，利用 MAC 算法验证消息完整性之前，需要在通信两端部署相同的密钥。

### SSL / TLS

SSL/TLS 握手（SSL/TLS 握手是为了安全地协商出一份对称加密的秘钥，称为【会话密钥】）

握手过程

- Client Hello 第一步是客户端向服务端发送 Client Hello 消息，这个消息里包含了一个客户端生成的随机数 Random1、客户端支持的加密套件（Support Ciphers）和 SSL Version 等信息

- Server Hello 第二步是服务端向客户端发送 Server Hello 消息，这个消息会从 Client Hello 传过来的 Support Ciphers 里确定一份加密套件，这个套件决定了后续加密和生成摘要时具体使用哪些算法，另外还会生成一份随机数 Random2。注意，至此客户端和服务端都拥有了两个随机数（Random1+ Random2），这两个随机数会在后续生成对称秘钥（会话密钥）时用到。

- Certificate 这一步是服务端将自己的证书下发给客户端，让客户端验证服务端的身份，客户端验证通过后取出证书中的公钥。

- Server Key Exchange 服务端向客户端发送 PubKey

- Certificate Request 是服务端要求客户端上报证书，这一步是可选的，对于安全性要求高的场景会用到。（可选）

- Server Hello Done

- Certificate Verify 证书验证

- Client Key Exchange 用上面客户端根据服务器传来的公钥生成了 PreMaster Key，Client Key Exchange 就是将这个 key 传给服务端，服务端再用自己的私钥解出这个 PreMaster Key 得到客户端生成的 Random3。至此，客户端和服务端都拥有 Random1 + Random2 + Random3，两边再根据同样的算法（加密套件）就可以生成一份会话密钥，握手结束后的应用层数据都是使用这个会话密钥进行对称加密。

- Change Cipher Spec(Client) 这一步是客户端通知服务端后面再发送的消息都会使用前面协商出来的会话密钥加密了

- Encrypted Handshake Message(Client) 这一步对应的是 Client Finish 消息，客户端将前面的握手消息生成摘要再用协商好的会话密钥加密，这是客户端发出的第一条加密消息。服务端接收用会话密钥解密，能解出来说明前面协商出来的秘钥是一致的。

- Change Cipher Spec(Server) 这一步是服务端通知客户端后面再发送的消息都会使用加密，也是一条事件消息。

- Encrypted Handshake Message(Server) 这一步对应的是 Server Finish 消息，服务端也会将握手过程的消息生成摘要再用会话密钥加密，这是服务端发出的第一条加密消息。客户端接收后用会话密钥解密，能解出来说明协商的秘钥是一致的。

- Application Data 到这里，双方已安全地协商出了同一份会话密钥，所有的应用层数据都会用这个会话密钥加密后再通过 TCP 进行可靠传输。

# 确认访问用户身份的认证

## HTTP 认证方式

1. BSAIC 认证 基本认证

用户 ID+密码 用:连接再 base64 编码

缺点： 安全性低，不常用

2. DIGEST 认证 摘要认证

达不到多数 Web 网站对高度安全等级的追求标准。

3. SSL 客户端认证

借由 HTTPS 的客户端证书完成认证的方式。

1. 接收到需要认证资源的请求，服务器会发送 Certificate Request 报文，要求客户端提供客户端证书

2. SSL 客户端认证不会仅依靠证书完成认证，一般会和基于表单认证（稍后讲解）组合形成一种双因素认证（Two-factor authentication）来使用。所谓双因素认证就是指，认证过程中不仅需要密码这一个因素，还需要申请认证者提供其他持有信息，从而作为另一个因素，与其组合使用的认证方式。

3. SSL 客户端认证需要用到客户端证书。而客户端证书需要支付一定费用才能使用，尚未普及

4. FORMBASE 认证 基于表单的认证

步骤：

- 客户端把用户 ID 和密码等登录信息放入报文的实体部分，通常是以 POST 方法把请求发送给服务器

- 服务器会发放用以识别用户的 Session ID。通过验证从客户端发送过来的登录信息进行身份认证，然后把用户的认证状态与 Session ID 绑定后记录在服务器端（set-cookie）

- 客户端接收到从服务器端发来的 Session ID 后，会将其作为 Cookie 保存在本地

# 基于 HTTP 的功能追加协议

HTTP 客户端一般对同一个服务器的并发连接个数都是有限制的。

实际上，浏览器确实使用并行连接，但它们将并行连接的总数限制为少量（通常为四个 / 六个）。服务器可以自由地关闭来自特定客户端的过多连接。

浏览器对于同一个域名，同时只能有 4 / 6 个连接（这个根据浏览器内核不同可能会有所差异），超过浏览器最大连接数限制，后续请求就会被阻塞。

## SPDY （speedy）

- SPDY 没有完全改写 HTTP 协议，而是在 TCP/IP 的应用层与传输层之间通过新加会话层的形式运作。同时，考虑到安全性问题，SPDY 规定通信中使用 SSL。（在 http 和 ssl 中间）

- SPDY 以会话层的形式加入，控制对数据的流动，但还是采用 HTTP 建立通信连接。因此，可照常使用 HTTP 的 GET 和 POST 等方法、Cookie 以及 HTTP 报文等。

- 获得的功能：1. 多路复用 2. 首部压缩 3. 服务器推送 4. 服务器提示 5. 赋予请求优先级

## WebSocket 基于 HTTP 在 HTTP 连接建立后再进行一次握手（Upgrade 协议）

特点：

1. 持久连接

2. 服务器可以主动向客户端推送信息，客户端也可以主动向服务器发送信息。

3. 可以传递任意格式数据

### WebSocket 的握手：

为了实现 WebSocket 通信，在 HTTP 连接建立之后，需要完成一次“握手”（Handshaking）的步骤：

1. 握手请求：客户端发出握手请求，需要发送 Upgrade 首部字段，告知服务器通信协议发生改变，以达到握手的目的。还需要发送的字段包括：Sec-WebSocket-Key 字段，记录着握手过程中必不可少的键值；Sec-WebSocket-Protocol 字段内记录使用的子协议。

2. 握手响应：服务端对于之前的请求，返回状态码 101 Switching Protocols 的响应，响应还需要发送 Sec-WebSocket-Accept 字段，字段值是由握手请求中的 Sec-WebSocket-Key 的字段值生成的

### HTTP2.0

- 二进制分帧

帧： HTTP2.0 通信的最小单位

- 首部压缩

- 多路复用

在 HTTP1.1 中，浏览器客户端在同一时间，针对同一域名下的请求有一定数量的限制。超过限制数目的请求会被阻塞。而 HTTP2.0 中的多路复用优化了这一性能。

- 请求优先级

- 服务端推送

### WebDAV

可对 Web 服务器上的内容直接进行文件复制、编辑等操作的分布式文件系统。
