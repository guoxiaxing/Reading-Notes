# web 简介

## 协议： 一种约定

## HTTTP： 应用层协议，超文本传输协议

## TCP/IP 协议族 -》 http 是 tcp/ip 协议族的一部分

- 应用层 ： http dns ftp

决定了向用户提供应用服务时通信的活动

- 传输层： tcp udp

处理网络中两台计算机之间的通信

- 网络层： ip

处理网络上流动的数据包，路线选择&数据包传送

- 数据链路层

硬件部分

## tcp/ip 数据传输流动

发送端每经过一层就会在数据外面包裹上该层的首部信息，接收方没经过一层就会去掉该层首部

传输层会对 http 报文进行分割

## ip 协议

ipv4 32 位

ipv6 128 位

发送数据包

ip 地址可能会变，和所在的局域网有关，mac 地址（网卡所属的固定地址）是 48 位，基本不变（唯一的）

arp 地址解析协议 -》 ip 地址和 mac 地址之间的转换

## tcp 协议 -》 可靠的字节流服务

将 http 报文分割成报文段进行管理

syn 报文 -》 同步报文

fin 报文 -》 断开链接

ack 报文 -》 确认报文

## 三次握手

1. 客 -> 服 syn

2. 服 -> 客 syn + ack

3. 客 -> 服 ack

## ?? 三次握手而不是两次握手的原因

网络层是不可靠的，所以还是有可能发生丢包，只不过 tcp 有处理丢包的策略

如果是两次握手：加入客户端的请求在网络中的某一个地方被滞留，导致到达服务器的时间较久（已变为一个失效的链接）此时当服务器收到这个请求的时候，会认为客户端是想建立一个链接，所以就会返回一个确认报文并建立链接，而对于客户端来说，并没有数据要发送，所以也就不理会服务器的确认，而服务器还依然保持这个链接等待客户端发送数据，导致服务器的资源被浪费。这也就是 syn 攻击的由来

## 四次挥手（断开链接）可以是客户端断开链接/服务端断开链接

1. ke -> fu fin

2. fu -> ke ack （此时服务端还在传送数据，所以暂时不关闭，等待数据传输完毕）

3. fu -> ke fin

4. ke -> fu ack 链接关闭

## DNS - 域名系统 提供 IP 地址和域名之间的相互转换

递归查找域名对应的 IP 地址

1. 本地域名服务器

2. 根级域名服务器

3. 顶级域名服务器

4. 全球域名服务器

# 简单的 HTTP 协议

## 持久链接

http1.1 默认就是持久链接，一个 tcp 链接上可以发送多个请求/响应（但是不能超过 4 个，大多数浏览器都有限制）

http1.0 需要通过 Connection: Keep-Alive 来声明一个持久链接

优点：

1. 降低了服务器的压力

2. 页面响应速度加快

3. 降低了建立 tcp 链接的开销

断开：

Coonection: close

Keep-Alive: timeout=x;

## 管道化

可以并行发送多个请求

## Cookie

因为 http 是无状态的，所以需要 cookie 来记录用户的登陆信息

set-cookie --- 服务器设置 cookie

cookie --- 客户端在请求的时候携带 cookie 用于身份认证

# HTTP 信息

## HTTP 报文结构

- 报文首部

请求行/状态行

请求行：

请求方法

请求 url

协议版本

状态行：

http 版本

状态吗

状态短语

请求/响应首部字段

通用首部字段

实体首部字段

其它

- 空行

- 报文主体 （实质发送的数据）

> 报文主体和实体主体的区别：

报文主体和实体主体是一样的，但是在对传送的内容进行（实体）编码之后，报文主体和报文实体就会有差别

## 提升传输效率

内容编码：

content-encoding

accept-encoding

tansfer-encoding

服务端进行编码，客户端根据 content-encoding 进行解码

content-length 指的是编码前的实体长度

### 获取部分内容的请求

Range: bytes=n1-n2

单位是字节 206 请求成功，返回部分内容，不支持部分请求是直接返回 200 全部请求内容

### 内容协商

content-language

accept

content-type

# HTTP 状态码

1xx --- 服务端正在处理请求

2xx --- 服务器正常处理完请求

200 -- ok

206 --- 部分响应

204 --- no content

3xx --- 重定向，客户端需要进一步进行操作

304 - not modified 可以使用客户端缓存

301 永久重定向 重定向为 get 请求 会导致 post 请求的 body 被丢弃

302 临时重定向 重定向为 get 请求 会导致 post 请求的 body 被丢弃

303 临时重定向 所有请求都会重定向为 get 请求 会导致 post 请求的 body 被丢弃

307 临时重定向 post 请求不会被重定向为 get 请求

308 永久重定向 post 请求不会被重定向为 get 请求

4xx --- 客户端错误

400 - bad request 请求报文存在语法错误

404 - not found 请求的资源不存在

401 - 需要权限

403 - 禁止访问

5xx --- 服务器错误

500 - 服务器内部错误

503 - 服务不可用 如果维护时间已知可以将它写在 retry-after 首部返回给客户端

## 传输编码和内容编码

内容编码：内容编码是在传输前进行的，一般是为了对实体主体进行压缩

传输编码：传输编码是在传输的过程中进行编码，在内容编码的基础上，可以继续对实体主体进行传输编码，使其可以分块传输，也可以不进行分块传输编码直接一次性进行完整传输

content-length 指定传输给对方的消息实体的大小 （有 transfer-encoding 时没有 content-length）

# web 服务器

web 服务器专门处理 http 请求

单台虚拟主机可以模拟多个域名

## 通信数据转发程序： 代理、网关、隧道

代理： 转发 http 请求，但是不会改变请求的 URL

缓存代理

透明代理

via 首部记录每次经过的代理

max-forwards 规定最大转发次数

网关： 和代理的工作机制很相似，但是网关可以处理非 http 请求

隧道： 建立通信的安全通道

## 资源缓存

客户端和缓存服务器都可以实现对资源的缓存，降低服务器的压力

# HTTP 报文首部

- 请求首部

1. accept

2. accept-encoding

3. accept-charset

4. accept-language

5. host

6. expect

7. authorization

8. if-match/if-none-match

9. if-modified-since/if-nomodified-since

10. if-range

11. range

12. refer

13. user-agent

14. TE

15. proxy-authorizetion

- 响应首部

2. etag

3. server

4. Accept-Ranges

5. Location

6. Proxy-Authenticate

7. retry-after

8. vary

9. WWW-Authenticate

- 通用首部

2. date

3. cache-control

4. connection

5. pragma

6. trailer

7. transfer-encoding

8. upgrade

9. via

10. Warning

- 主体首部

1. Allow

2. content-type

3. content-encoding

4. content-language

5. content-length

6. content-location

7. content-md5

8. content-range

9. Expires

10. last-modified

# cookie 的属性字段

expires

max-age

secure

HttpOnly

domain -- 包含子域

path

# 其它首部字段

- x-frame-options: 响应首部 控制该页面是否能被潜到 iframe 中

DENY：拒绝，不允许任何网站的 frame 进行加载

SAMEORIGIN：仅同源域名下的页面（Top-level-browsing-context）匹配时许可

Allow-From uri：该页面可以在指定来源的 frame 中展示。

- X-XSS-Protection 响应首部

- DNT 请求首部 拒绝被追踪

- P3P

# 确保 web 安全的 HTTPS

## http 的缺点

1. 信息明文传递，容易被监听

2. 无法认证通信双方身份，容易伪装

3. 不能验证完整性，容易在传输的时候被篡改

## 加密+认证+完整性校验 = HTTPS

### 加密

1. 共享密钥加密 --- 对称加密

加密和解密使用相同密钥，需要传输内容的时候发送密钥，但是无法保证密钥的安全传送

2. 公开密钥加密 --- 非对称加密

使用公钥加密，使用私钥解密

缺点：速度慢，无法认证公钥的有效性（解决方法：数字证书）

3. 混合加密：（对称加密+非对称加密）

- 在密钥交换的环节进行非对称加密

- 数据传输阶段进行对称加密

### 认证 （CA）

数字证书是由可以信赖的第三方颁发的。（证书中包含公钥）

服务器会将包含公钥的证书发送给客户端。

客户端会对证书的有效性进行认证。认证成功可以确认两件事：1. 颁发证书的机构是确实可信赖的 2. 服务器是可信赖的

### 完整性保护

为了防止传输的内容被篡改，SSL 引入了完整性校验 MD5 / MAC 算法

MAC 算法需要密钥，可以保证通信双方是我们想要进行通信的双方

无法进行根据结果推算出内容

MAC 算法是在密钥参与下的数据摘要算法，能将密钥和任意长度的数据转换为固定长度的数据。

## SSL/TLS

SSL/TLS 握手是为了协商出一个用于对称加密的会话密钥

1. client-hello 发送客户端支持的加密套件，协议的版本，random1

2. server-hello 发送服务器选择的加密套件，协议版本，random2

3. 服务器发送自己带有公钥的证书给客户端

4. 客户端验证证书的有效性并取出公钥，客户端利用公钥生成一个 preMaster key 传递给服务器

5. 服务端利用自己的私钥解密出这个 preMaster Key -> 得到 random3 （此时客户端和服务器有三个随机数 random1-3）服客户端&务器使用选择的加密算法对三个随机数进行加密，得到会话密钥，握手结束后，服务器和客户端都会使用这个会话密钥进行对称加密

# 确定访问用户的身份

## BASIC 验证（基础验证）

将用户 ID 和密码使用冒号链接之后再进行 base64 编码

缺点： 安全性低

## DIGEST 验证（摘要验证）

安全性也不高

## SSL 客户端证书

服务器对客户端的数字证书进行认证

一般会使用双因素认证：SSL 客户端证书+基于表单的认证

缺点： SSL 证书需要一定的费用

## 基于表单的认证

需要借助 cookie 和 session 来存储验证信息

客户端将用户 ID 和密码通过 POST 请求发送给服务器

服务器判断用户状态并生成一个 sessionID 与用户的登陆状态绑定 放在 set-cookie 字段中发送给浏览器

浏览器下次请求该服务器的时候会在 cookie 字段中携带 session ID 用于服务器对用户身份的判断

# 基于 HTTP 的功能追加协议

## SPDY（speedy）

也还是基于 htttp 的，而且需要 ssl，在 ssl 和 http 中间

特点：

1. 首部压缩

2. 多路复用

3. 服务器推送

4. 服务器提醒

5. 赋予请求优先级

## websocket 基于 http 协议

在完成 http 握手之后再发送一个握手请求，带有 upgrade(达到握手的目的)，表示协议升级

Sec-WebSocket-Key 字段，记录着握手过程中必不可少的键值；Sec-WebSocket-Protocol 字段内记录使用的子协议

服务器返回 101 状态码，Sec-WebSocket-Accept 字段，字段值是由握手请求中的 Sec-WebSocket-Key 的字段值生成的

特点：

持久链接：链接建立有一直会保持链接

服务器和客户端都可以相互发送消息

## HTTP2.0

特点；

1. 多路复用，一个链接上可以并行发送多个请求（没有数量限制）

2. 首部压缩

3. 服务器推送

4. 二进制分帧传输内容（兼容性更好）

## webDAV

对 web 服务器上的文件进行操作

# 构建 web 内容的技术

1. HTML

2. CSS

3. JavaScript

4. XML/json

# web 攻击技术

- 主动攻击： 攻击者主动访问 web 应用，注入攻击代码 sql 注入，os 攻击

- 被动攻击： 攻击者设置陷阱，诱导用户访问而达到攻击目的，不直接访问 web 应用 XSS，CSRF

## 因输出值转译不安全引发的漏洞

1. XSS

2. SQL 注入

3. OS 命令注入

4. HTTP 首部注入攻击

5. 邮件首部注入攻击

6. 目录遍历攻击

7. 远程文件包含漏洞

## 因设置或者设计上的缺陷引发的漏洞

1. 强制浏览

2. 不正确的错误消息处理

3. 开放重定向

## 因会话管理疏忽引发的安全漏洞

1. 会话劫持（session ID 利用已经认证过的用户的 sessionID 发送请求）

2. 跨站请求伪造 CSRF 获取用户登陆完成后的 cookie

# 其它安全漏洞

## 密码破解

### 网络密码破解

1. 穷举法

2. 字典法

### 已加密的密码破解

1. 穷举法/字典

2. 彩虹表

3. 盗取密钥

4. 加密算法本身存在漏洞

## 点击劫持

## DOS 攻击

1. 海量请求导致服务器不可用

2. 攻击服务器的安全漏洞导致服务不可用

## 后门程序

## 安全要素

1. 完整性

2. 机密性

3. 可用性

4. 不可否认性

5. 可控性
